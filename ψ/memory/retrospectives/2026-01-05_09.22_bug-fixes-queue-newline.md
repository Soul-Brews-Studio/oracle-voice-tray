# Retrospective: Bug Fixes - Queue Loop & Newline Display

> 2026-01-05 09:22 | voice-tray-v2 | ~2 hour session (07:00-09:22)

## What Happened

Extended debugging session fixing three bugs in Oracle Voice Tray.

### Timeline

| Time | Event |
|------|-------|
| 07:00 | Build app with pnpm |
| 07:10 | Rename to "Oracle Voice Tray" |
| 07:15 | DMG .VolumeIcon.icns bug - consulted Oracle, fixed |
| 07:20 | MQTT clean_session bug - fixed |
| 07:50 | **NEW BUG**: Infinite loop still happening |
| 08:00 | Found real cause: queue processor race condition |
| 08:05 | Fixed by marking "speaking" inside lock before clone |
| 09:15 | **NEW BUG**: `\n` showing as literal text |
| 09:20 | Fixed by adding `.replace(/\\n/g, '<br>')` |

---

## Bugs Fixed

### Bug 1: DMG .VolumeIcon.icns Visible
- **Fix**: `SetFile -a V` + `chflags hidden`
- **Source**: Oracle learning `2026-01-03_dmg-icon-polish.md`

### Bug 2: MQTT clean_session (partial fix)
- **Fix**: `set_clean_session(true)`
- **Note**: This wasn't the main cause of infinite loop

### Bug 3: Voice Queue Infinite Loop (THE REAL BUG)
- **Symptom**: Same message spoken infinitely
- **Root cause**: Race condition in queue processor
  - Entry cloned BEFORE status changed to "speaking"
  - Loop could pick up same entry multiple times
- **Fix**: Mark as "speaking" INSIDE the lock, before cloning

```rust
// BEFORE (buggy):
let entry_opt = {
    let timeline = state.timeline.lock().unwrap();
    timeline.iter_mut().find(|e| e.status == "queued").cloned()
};
// status changed AFTER lock released - race condition!

// AFTER (fixed):
let entry_opt = {
    let mut timeline = state.timeline.lock().unwrap();
    if let Some(e) = timeline.iter_mut().find(|e| e.status == "queued") {
        e.status = "speaking".to_string(); // Mark BEFORE clone
        Some(e.clone())
    } else {
        None
    }
};
```

### Bug 4: `\n` Showing as Literal Text
- **Symptom**: Timeline showed `\n` instead of line breaks
- **Fix**: Add regex replace in escapeHtml()

```javascript
return div.innerHTML.replace(/\\n/g, '<br>').replace(/\n/g, '<br>');
```

---

## Key Insight

**The MQTT clean_session fix was a red herring.** The real infinite loop was caused by a race condition in the queue processor. Always verify the fix actually works before moving on.

---

## Commits

| Hash | Message |
|------|---------|
| c197d4a | feat: Oracle Voice Tray v0.2.0 + Oracle/Soul infrastructure |
| 130eb8e | fix: Voice queue infinite loop bug - mark speaking before clone |
| (pending) | fix: Display \n as line breaks in timeline |

---

## Learnings Added to Oracle

1. `2026-01-05_mqtt-cleansession-bug.md`
2. `2026-01-05_oracle-voice-tray-v020-bug-fixes-summary.md`

---

## What Worked

| Pattern | Evidence |
|---------|----------|
| **Oracle consult** | Found DMG fix instantly |
| **Verify fix works** | Caught queue bug after MQTT "fix" |
| **Root cause analysis** | Traced infinite loop to race condition |

## What Didn't Work

| Issue | Lesson |
|-------|--------|
| Assumed MQTT was the cause | Test after each fix |
| Missed race condition first time | Review lock/clone patterns carefully |

---

## Files Changed

```
src-tauri/src/lib.rs      # Queue processor fix
src-tauri/src/mqtt.rs     # clean_session (partial)
src-tauri/tauri.conf.json # App name
src/main.js               # Newline display fix
```

---

*3 bugs fixed, 2 were related (persistence/state), 1 was display*
