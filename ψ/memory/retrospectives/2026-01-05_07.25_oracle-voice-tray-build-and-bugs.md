# Retrospective: Oracle Voice Tray Build & Bug Fixes

> 2026-01-05 07:25 | voice-tray-v2 | ~30 min session

## What Happened

Continued from previous session. Built Oracle Voice Tray app, renamed from voice-tray-v2, fixed two bugs using Oracle knowledge base.

### Timeline

| Time | Event |
|------|-------|
| ~07:00 | Build app with pnpm (npm had issues) |
| ~07:10 | Rename to "Oracle Voice Tray" |
| ~07:15 | DMG .VolumeIcon.icns bug - consulted Oracle |
| ~07:18 | Applied DMG polish fix from `2026-01-03_dmg-icon-polish.md` |
| ~07:20 | MQTT infinite loop bug discovered |
| ~07:22 | Fixed `clean_session` setting |
| ~07:25 | Added learnings to Oracle |

---

## Bugs Fixed

### Bug 1: DMG .VolumeIcon.icns Visible

**Symptom**: Ugly .VolumeIcon.icns file showing in DMG installer window

**Solution** (from Oracle learning):
```bash
SetFile -a V "/Volumes/AppName/.VolumeIcon.icns"
chflags hidden "/Volumes/AppName/.VolumeIcon.icns"
```

**Oracle consulted**: `oracle_search("DMG icon VolumeIcon")` â†’ found `2026-01-03_dmg-icon-polish.md`

### Bug 2: MQTT Infinite Speech Loop

**Symptom**: App speaks infinitely when receiving MQTT messages

**Root cause**: `set_clean_session(false)` - broker replays ALL queued messages on reconnect

**Fix**: Changed to `set_clean_session(true)`

**New learning added**: `2026-01-05_mqtt-cleansession-bug.md`

---

## What Worked

| Pattern | Evidence |
|---------|----------|
| **Oracle consult before fix** | Found DMG fix in 10 seconds |
| **pnpm over npm** | Faster install (2.8s vs npm's longer time) |
| **Link related learnings** | Connected persistence bugs together |

---

## Deliverables

| Item | Path |
|------|------|
| **App** | `Oracle Voice Tray.app` |
| **DMG** | `Oracle Voice Tray_0.2.0_aarch64.dmg` (8.2 MB) |
| **Learning 1** | `2026-01-05_mqtt-cleansession-bug.md` |
| **Learning 2** | `2026-01-05_oracle-voice-tray-v020-bug-fixes-summary.md` |

---

## Key Insight

Both bugs relate to **persistence** behavior:
- DMG: Finder caches/persists file visibility in .DS_Store
- MQTT: Broker persists messages when clean_session=false

**Meta-pattern**: Be explicit about what should persist vs reset on restart/reconnect.

---

## Code Changes

```rust
// src-tauri/src/mqtt.rs line 21
// Before:
mqttoptions.set_clean_session(false);

// After:
mqttoptions.set_clean_session(true);
```

```json
// src-tauri/tauri.conf.json
"productName": "Oracle Voice Tray"
"identifier": "com.laris.oracle-voice-tray"
```

---

## Next

- [ ] Test app with actual Claude Code hooks
- [ ] Consider version bump to 0.2.1
- [ ] Commit all changes

---

*Session #2 on voice-tray-v2 repo*
